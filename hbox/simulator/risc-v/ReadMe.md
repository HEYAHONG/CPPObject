# ***尚未实现*** 

# 说明

本目录主要用于实现对RISC-V指令集的模拟，主要实现在低端嵌入式平台下对RISC-V裸机环境(主要偏向模拟指令执行情况而非实际硬件)的模拟。

对于非低端嵌入式平台上可采用[riscv-isa-sim](https://github.com/riscv-software-src/riscv-isa-sim.git)工具，本目录也参考其实现相应功能。

对于系统级模拟(一般运行在非低端嵌入式平台)，推荐采用[qemu](https://www.qemu.org/)中对riscv32与riscv64的支持。

RISC-V的指令集分为基本指令集+扩展指令集，可相对灵活地选择自己的实现。

# 编译器/开发环境

对于RISC-V指令集的程序开发，主要采用以下编译器：

- [GCC](https://gcc.gnu.org/)
- [LLVM](https://llvm.org/)

## 裸机开发

裸机开发时，无论是32位开发还是64位开发，推荐采用目标为riscv64-unknown-elf的gcc工具链，此时C编译器的命令为`riscv64-unknown-elf-gcc`。C库采用[picolibc](https://github.com/picolibc/picolibc.git)或者Newlib。注意：如果是自己制作编译工具链，需要编译32位库支持，否则可能不能使用C库（可能可以编译无需C库的代码）。

在ubuntu24.04及更新的ubuntu系统可采用以下命令安装：

```bash
sudo apt-get install gcc-riscv64-unknown-elf
```

对于GCC而言(通常Clang兼容相应选项)，需要使用以下选项指定相应的指令集：

- **`-march`**:指定指令集，通常是基本指令集+扩展指令集，如rv32i指RV32I指令集，rv32ia值RV32I指令集+RV32A扩展指令集。
- **`-mcpu`**：指定处理器，通常用于具体的硬件处理器（或者处理器系列）。
- **`-mtune`**:指定处理器优化，通常用于具体的硬件处理器。

# 模型

## 地址空间

RISC-V通常采用统一编址，即所有主内存、I/O设备均在一块以字节编址的空间上。

地址空间的大小由XLEN决定，如32位系统的寻址空间大小为4GB，64位系统的寻址空间大小为16EB。

按照一般经验,地址的高位(根据实际需求决定数量)通常可用于特殊用途(如区分主内存与I/O设备、对于64位系统而言，也可用作特殊标志位),剩余低位用作具体内存或I/O设备的地址。

## 中断(异常)

RISC-V将侠义的异常与中断均称为异常，在本章节中若未特殊说明，异常指侠义的异常,即不包括中断。

RISC-V中断模式可分为以下模式(向量基地址寄存器`mtvec`低两位用于编码模式，其余位标识基地址(4字节对齐)):

- 模式0:直接模式。只有一个陷入函数用于处理中断(异常)，具体的中断号在软件中判断。中断陷入函数地址存储在向量基地址。
- 模式1:向量模式。具有一个4字节对齐的向量表。具体中断函数地址存储在向量基地址+4*(中断异常情况编码),而狭义的异常处理函数地址则由存储在向量基地址(即中断号为0的情况)。

中断号(中断异常情况编码)的分配如下:

- 中断号0到中断号15由RISC-V标准使用。
- 中断号16到中断号23由（硬件）平台使用。
- 中断号24到中断号31由用户自定义使用。
- 中断号32到中断号47由（硬件）平台使用，一般在64位及更高位数的系统中有效。
- 中断号48及更大的中断号由用户自定义使用，一般在64位及更高位数的系统中有效。

## 虚拟CPU模型

**注意:若未说明，本章节内容默认为自定义内容，而非RISC-V标准内容**

### 基础模型

本模型主要用于模拟RISC-V指令的执行。主要特点如下:

- 无内存管理单元(MMU)。
- 仅工作在机器模式(M-Mode)。
- 主要运行裸机环境代码。
- 内存占用小，可运行于低端嵌入式环境。

#### 地址空间

无论是32位系统还是64位系统，均采用32位地址空间(64位系统忽略高32位地址)。

地址高4位用于划分地址用途，4G地址空间被划分为16块，具体划分如下:

| 高4位值(HEX值) |    地址范围(HEX值)    | 说明                                                     |
| :------------: | :-------------------: | -------------------------------------------------------- |
|       0        | 0x00000000-0x0FFFFFFF | 可映射的程序代码块。可映射为Flash或者内部ROM(如果有的话) |
|       1        | 0x10000000-0x1FFFFFFF | Flash映射地址。                                          |
|       2        | 0x20000000-0x2FFFFFFF | RAM映射地址。                                            |
|       E        | 0xE0000000-0xEFFFFFFF | I/O设备映射地址。                                        |
|       F        | 0xF0000000-0xFFFFFFFF | 虚拟CPU信息地址，如一些内部的寄存器。                    |

#### 中断

向量基地址固定为0x00000001,即基地址为0，默认为向量模式,不可修改。

中断号16(中断异常情况编码16)用作用作复位中断。

# 官方资料

- 官网：https://riscv.org/
- [riscv-opcodes](https://github.com/riscv/riscv-opcodes)
- [riscv-isa-manual](https://github.com/riscv/riscv-isa-manual)

